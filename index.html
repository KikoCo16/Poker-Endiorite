<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>üÉè Poker</title>
<style>
*{box-sizing:border-box;}
body{margin:0;min-height:100vh;background:radial-gradient(circle at top,#0f172a,#020617);font-family:system-ui,Arial,sans-serif;color:#f0f9ff;display:flex;justify-content:center;align-items:center;padding:20px;}
.card{width:100%;max-width:480px;background:#0b1120;border-radius:16px;padding:24px;border:1px solid #1e3a8a;box-shadow:0 10px 40px rgba(0,0,0,0.8),0 0 20px rgba(30,58,138,0.2);}
h1{text-align:center;margin:12px 0;color:#60a5fa;font-size:1.8rem;}
input{width:100%;padding:14px;margin:8px 0;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#bfdbfe;font-size:16px;}
input:focus{border-color:#3b82f6;box-shadow:0 0 8px rgba(59,130,246,0.3);}
button{width:100%;padding:14px;margin-top:10px;border:none;border-radius:10px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;font-weight:700;font-size:16px;cursor:pointer;transition:0.2s;}
button:hover{opacity:.9;}
button:active{transform:scale(0.98);}
.secondary{background:#1e293b;color:#94a3b8;border:1px solid #334155;}
.msg{text-align:center;color:#7dd3fc;font-size:14px;margin:10px 0;min-height:40px;}
.credit-box{text-align:center;font-size:24px;font-weight:bold;margin:15px 0;color:#3b82f6;text-shadow:0 0 10px rgba(59,130,246,0.4);}
.cards{display:flex;justify-content:center;gap:10px;font-size:28px;margin:10px 0;flex-wrap:wrap;}
.flex-row{display:flex;gap:10px;justify-content:center;margin-top:10px;}
</style>
</head>
<body>
<div class="card">
<h1>üÉè Poker</h1>
<div class="credit-box">üí∞ <span id="credits">0</span> cr√©dits</div>

<input id="buyIn" type="number" placeholder="Achetez votre cave (min 100)">
<div class="flex-row">
<button id="startBtn">‚ñ∂ Commencer</button>
<button id="backBtn" class="secondary">‚¨Ö Retour</button>
</div>

<div class="cards" id="playerCards"></div>
<div class="cards" id="botCards"></div>
<div class="cards" id="communityCards"></div>

<div class="flex-row">
<button id="foldBtn" class="secondary">Fold</button>
<button id="callBtn">Call</button>
<button id="raiseBtn">Raise</button>
</div>

<div class="msg" id="resultMsg"></div>
<div class="credit-box">Pot: <span id="pot">0</span></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDAQALLN99kqiYY4UZz9wl2stedP5KQ5mA",
  authDomain: "casino-b23c9.firebaseapp.com",
  databaseURL: "https://casino-b23c9-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "casino-b23c9",
  storageBucket: "casino-b23c9.appspot.com",
  messagingSenderId: "139229793155",
  appId: "1:139229793155:web:953b31b383a87bc3c504b6"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const currentUser = localStorage.getItem("casinoUser");
if(!currentUser){ alert("Vous devez vous connecter !"); window.location.href="https://kikoco16.github.io/Casino-Endiorite/"; }

const creditsEl = document.getElementById("credits");
const buyInInput = document.getElementById("buyIn");
const startBtn = document.getElementById("startBtn");
const backBtn = document.getElementById("backBtn");
const playerCardsEl = document.getElementById("playerCards");
const botCardsEl = document.getElementById("botCards");
const communityCardsEl = document.getElementById("communityCards");
const resultMsg = document.getElementById("resultMsg");
const foldBtn = document.getElementById("foldBtn");
const callBtn = document.getElementById("callBtn");
const raiseBtn = document.getElementById("raiseBtn");
const potEl = document.getElementById("pot");

let deck=[], playerHand=[], botHand=[], communityCards=[];
let pot=0, currentBet=0, playerBet=0, botBet=0;
let gameStage=0; 
let handFinished=false;
let cave=0;

const suits = ["‚ô†","‚ô•","‚ô¶","‚ô£"];
const values = ["2","3","4","5","6","7","8","9","10","J","Q","K","A"];
const multipliers = {"Quinte flush":4,"Carr√©":3,"Full":2.5,"Couleur":1.8,"Quinte":1.5,"Brelan":1.2,"Double paire":1.1,"Paire":1,"Hauteur":0.8};

async function refreshCredits(){
  const snap = await get(ref(db,"users/"+currentUser));
  creditsEl.textContent = snap.val().credits || 0;
}

function createDeck(){ 
  const d=[]; 
  for(const s of suits){ 
    for(const v of values) d.push(v+s);
  } 
  return d.sort(()=>Math.random()-0.5); 
}

function dealHands(){
  playerHand=[deck.pop(),deck.pop()];
  botHand=[deck.pop(),deck.pop()];
  communityCards=[];
  playerCardsEl.textContent=playerHand.join(" ");
  botCardsEl.textContent="ü§µ ü§µ";
  communityCardsEl.textContent="";
  pot=0; currentBet=0; playerBet=0; botBet=0; potEl.textContent=pot;
  resultMsg.textContent="Pr√©-flop : Call, Raise ou Fold";
  gameStage=0; handFinished=false;
  foldBtn.disabled=false; callBtn.disabled=false; raiseBtn.disabled=false;
}

function dealCommunity(n){ 
  for(let i=0;i<n;i++) communityCards.push(deck.pop()); 
  communityCardsEl.textContent=communityCards.join(" "); 
  gameStage++; 
}

function evaluateHand(hand){
  const ranks = hand.map(c=>c.slice(0,-1));
  const suitsArr = hand.map(c=>c.slice(-1));
  const counts = {}; ranks.forEach(r=>counts[r]=(counts[r]||0)+1); 
  const freq = Object.values(counts).sort((a,b)=>b-a);
  const flush = new Set(suitsArr).size===1;
  let rankNums = ranks.map(r=>{
    if(r==="A") return 14; 
    if(r==="K") return 13; 
    if(r==="Q") return 12; 
    if(r==="J") return 11; 
    return Number(r);
  }).sort((a,b)=>a-b);
  let straight=true; 
  for(let i=0;i<rankNums.length-1;i++){ if(rankNums[i+1]-rankNums[i]!==1){ straight=false; break; } }
  if(rankNums.toString()==="2,3,4,5,14") straight=true;
  if(straight&&flush) return {name:"Quinte flush",mult:multipliers["Quinte flush"]};
  if(freq[0]===4) return {name:"Carr√©",mult:multipliers["Carr√©"]};
  if(freq[0]===3&&freq[1]===2) return {name:"Full",mult:multipliers["Full"]};
  if(flush) return {name:"Couleur",mult:multipliers["Couleur"]};
  if(straight) return {name:"Quinte",mult:multipliers["Quinte"]};
  if(freq[0]===3) return {name:"Brelan",mult:multipliers["Brelan"]};
  if(freq[0]===2&&freq[1]===2) return {name:"Double paire",mult:multipliers["Double paire"]};
  if(freq[0]===2) return {name:"Paire",mult:multipliers["Paire"]};
  return {name:"Hauteur",mult:multipliers["Hauteur"]};
}

async function playerAction(action, amount=0){
  if(handFinished) return;
  foldBtn.disabled=true; callBtn.disabled=true; raiseBtn.disabled=true;

  if(action==="fold"){
    resultMsg.textContent="Vous avez fold√© ! Bot gagne le pot";
    await endHand("bot");
    return;
  }

  if(action==="call"){
    let diff = currentBet-playerBet;
    let diffCapped = Math.min(diff, cave-playerBet);
    playerBet+=diffCapped; pot+=diffCapped; potEl.textContent=pot;
    await botTurn();
  }

  if(action==="raise"){
    amount=Math.min(amount, cave-playerBet);
    if(amount<=0){ 
      resultMsg.textContent="Mise invalide"; 
      foldBtn.disabled=false; callBtn.disabled=false; raiseBtn.disabled=false; 
      return; 
    }
    playerBet+=amount; pot+=amount; currentBet=playerBet; potEl.textContent=pot;
    resultMsg.textContent=`Vous relancez ${amount} cr√©dits`;
    await botTurn();
  }
}

async function botTurn(){
  if(handFinished) return;
  const r=Math.random();
  if(r<0.6){ await endHand("bot"); return; }
  if(gameStage<3){ nextStage(); foldBtn.disabled=false; callBtn.disabled=false; raiseBtn.disabled=false; } 
  else{ showdown(); }
}

function nextStage(){
  if(handFinished) return;
  if(gameStage===0){ dealCommunity(3); resultMsg.textContent="Flop"; }
  else if(gameStage===1){ dealCommunity(1); resultMsg.textContent="Turn"; }
  else if(gameStage===2){ dealCommunity(1); resultMsg.textContent="River"; }
  else if(gameStage>=3){ showdown(); }
}

async function endHand(winner){
  if(handFinished) return;
  handFinished=true;
  foldBtn.disabled=true; callBtn.disabled=true; raiseBtn.disabled=true;
  botCardsEl.textContent=botHand.join(" ");
  const snap=await get(ref(db,"users/"+currentUser));
  const banqueSnap=await get(ref(db,"users/Banque Centrale"));
  let newCredits=snap.val().credits||0;
  let banqueCredits=banqueSnap.val().credits||1000000;
  if(winner==="player"){ 
    newCredits+=pot; 
    banqueCredits-=pot; 
    resultMsg.textContent+=" üéâ Vous gagnez "+pot+" cr√©dits !"; 
  }
  else if(winner==="bot"){ 
    let lost=Math.min(playerBet,newCredits);
    newCredits-=lost; 
    banqueCredits+=lost; 
    resultMsg.textContent+=" üò¢ Vous perdez "+lost+" cr√©dits"; 
  }
  await update(ref(db,"users/"+currentUser),{credits:newCredits,password:snap.val().password});
  await update(ref(db,"users/Banque Centrale"),{credits:banqueCredits,password:banqueSnap.val().password});
  refreshCredits();
}

function showdown(){
  const playerEval=evaluateHand([...playerHand,...communityCards]);
  const botEval=evaluateHand([...botHand,...communityCards]);
  if(playerEval.mult>botEval.mult) endHand("player");
  else endHand("bot");
}

startBtn.onclick=async ()=>{
  let buyIn = Number(buyInInput.value);
  if(buyIn<100){ resultMsg.textContent="Cave min 100 cr√©dits"; return; }
  const snap=await get(ref(db,"users/"+currentUser));
  if(buyIn>snap.val().credits){ resultMsg.textContent="Cr√©dits insuffisants"; return; }
  cave=buyIn;
  await update(ref(db,"users/"+currentUser),{credits:snap.val().credits-buyIn,password:snap.val().password});
  refreshCredits(); deck=createDeck(); dealHands();
}

foldBtn.onclick=()=>playerAction("fold");
callBtn.onclick=()=>playerAction("call");
raiseBtn.onclick=()=>playerAction("raise",Number(prompt("Montant √† relancer?","10")));
backBtn.onclick=()=>window.location.href="https://kikoco16.github.io/Casino-Endiorite/";

refreshCredits();
</script>
</body>
</html>
